# Руководство по универсальному конвертеру эфемерид

## Обзор

Универсальный конвертер позволяет гибко конвертировать эфемериды JPL DE и EPM в оптимизированный формат `.eph` с индивидуальными настройками для каждого тела.

## Основные возможности

- ✅ **Гибкий выбор тел**: выбирайте любые тела из доступных в источнике
- ✅ **Оптимизированные интервалы**: автоматические нативные интервалы для каждого тела
- ✅ **Профили конвертации**: готовые наборы для типовых задач
- ✅ **Множественные источники**: JPL DE440, DE441, DE431, EPM2021
- ✅ **Статистика**: сравнение размеров и сжатие

## Быстрый старт

### Список доступных источников
```bash
python tools/universal_converter.py --list-sources
```

**Вывод:**
- `de440`: JPL DE440 (1550-2650 AD, 1100 лет, 12 тел)
- `de441`: JPL DE441 (-13200 to +17191, 30390 лет, 14 тел)
- `de431_part1`: JPL DE431 Part 1 (-13200 to 1 AD, 13200 лет, 14 тел)
- `de431_part2`: JPL DE431 Part 2 (1 AD to +17191, 17190 лет, 14 тел)
- `epm2021`: EPM2021 (1788-2215 AD, 427 лет, **22 тела включая TNO**)

### Список профилей конвертации
```bash
python tools/universal_converter.py --list-profiles
```

**Профили:**
- `standard`: 12 основных тел с нативными интервалами
- `full_epm`: Полный EPM2021 с уникальными TNO (Sedna, Haumea, Eris, Makemake)
- `minimal`: Минимальный набор (Солнце, Луна, планеты)
- `astrology`: Для астрологии (основные тела)

## Примеры использования

### 1. Стандартная конвертация JPL DE440
```bash
python tools/universal_converter.py \
    --source de440 \
    --profile standard \
    --output data/ephemerides/jpl/de440.eph
```

Результат: 12 основных тел (Mercury-Pluto, Sun, Moon, Earth) с оптимизированными интервалами:
- Moon: 8 дней
- Mercury: 8 дней
- Venus: 16 дней
- Остальные планеты: 32-64 дня

### 2. Полная конвертация EPM2021 с уникальными телами
```bash
python tools/universal_converter.py \
    --source epm2021 \
    --profile full_epm \
    --output data/ephemerides/epm/2021/epm2021_full.eph
```

Результат: **21 тело** включая:
- 12 основных планет
- 5 астероидов (Ceres, Pallas, Vesta, Iris, Bamberga)
- 4 TNO (Sedna, Haumea, Eris, Makemake)

**Уникальные тела EPM2021 (недоступны в JPL DE):**
- **2090377**: Sedna - далёкий TNO (128 дней)
- **2136108**: Haumea - карликовая планета (64 дня)
- **2136199**: Eris - карликовая планета (128 дней)
- **2136472**: Makemake - карликовая планета (64 дня)

### 3. Кастомный набор тел
```bash
python tools/universal_converter.py \
    --source epm2021 \
    --bodies 10,301,2090377,2136199 \
    --output sedna_eris.eph
```

Результат: Солнце (10), Луна (301), Sedna (2090377), Eris (2136199) с автоматическими нативными интервалами.

### 4. Кастомные интервалы для каждого тела
```bash
python tools/universal_converter.py \
    --source epm2021 \
    --bodies 10,301,2090377,2136199 \
    --intervals 32,8,128,128 \
    --output custom.eph
```

Результат: Индивидуальные интервалы для каждого тела (Sun=32d, Moon=8d, Sedna=128d, Eris=128d).

### 5. JPL DE440 vs EPM2021 - что выбрать?

**JPL DE440** - для максимальной точности (научные задачи):
```bash
python tools/universal_converter.py \
    --source de440 \
    --profile standard \
    --output de440_science.eph
```
- ✅ Лучшая точность: sub-meter (внутренние планеты)
- ✅ Современные константы (2021)
- ❌ Только 12 основных тел
- ❌ Короткое покрытие (1550-2650 AD)

**EPM2021** - для расширенного набора объектов:
```bash
python tools/universal_converter.py \
    --source epm2021 \
    --profile full_epm \
    --output epm2021_extended.eph
```
- ✅ 22 тела (включая TNO и астероиды)
- ✅ Улучшенные LLR данные для Луны
- ✅ Хорошая точность: ~20 км median
- ❌ Среднее покрытие (1788-2215 AD)

## Нативные интервалы Чебышёва

Конвертер автоматически использует оптимальные интервалы для каждого тела:

| Тело              | NAIF ID   | Интервал | Причина                  |
|-------------------|-----------|----------|--------------------------|
| Moon              | 301       | 8 дней   | Быстрое движение         |
| Mercury           | 1         | 8 дней   | Быстрое движение         |
| Venus             | 2, 299    | 16 дней  | Среднее движение         |
| EMB/Earth/Mars    | 3, 399, 4 | 32 дня   | Стандарт                 |
| Jupiter/Saturn    | 5, 6      | 32 дня   | Газовые гиганты          |
| Uranus/Neptune    | 7, 8      | 64 дня   | Медленное движение       |
| Pluto             | 9         | 64 дня   | Очень медленное          |
| TNO (Sedna, Eris) | 2090377...| 128 дней | Крайне медленное         |
| Астероиды         | 2000001...| 32 дня   | Средний пояс             |

**Преимущества нативных интервалов:**
- Минимальный размер файла
- Максимальная точность
- Оптимальная производительность

## Размеры и сжатие

| Источник       | Размер оригинала | Размер .eph | Сжатие | Интервалы |
|----------------|------------------|-------------|--------|-----------|
| EPM2021 (12)   | 147 MB           | ~27 MB      | 81.6%  | 16d uniform |
| EPM2021 (21)   | 147 MB           | ~45 MB      | 69.4%  | Native |
| DE440          | 97.5 MB          | ~20 MB      | 79.5%  | Native |
| DE431 Part 1   | 1,370 MB         | ~300 MB     | 78.1%  | 16d uniform |
| DE431 Part 2   | 1,784 MB         | ~400 MB     | 77.6%  | 16d uniform |

**Факторы сжатия:**
- SPICE DAF overhead (~20%)
- Удаление метаданных (~5%)
- Оптимизация структуры (~55%)

## Конфигурация

Все настройки хранятся в `tools/universal_converter_config.json`:

```json
{
  "sources": {
    "epm2021": {
      "path": "data/ephemerides/epm/2021/spice/epm2021.bsp",
      "available_bodies": [1, 2, ..., 2136472],
      "coverage": { "years": 427 }
    }
  },

  "body_intervals": {
    "301": { "name": "Moon", "interval_days": 8.0 },
    "2090377": { "name": "Sedna", "interval_days": 128.0 }
  },

  "conversion_profiles": {
    "full_epm": {
      "description": "Полная конвертация EPM2021",
      "bodies": [1, 2, ..., 2136472],
      "use_native_intervals": true
    }
  }
}
```

**Как добавить новый источник:**
1. Скачайте эфемериду
2. Добавьте в секцию `sources`
3. Укажите путь, доступные тела, покрытие
4. Создайте профиль или используйте --bodies

## Форматы вывода

### Текущие (реализованные):
- `eph_binary`: Оптимизированный бинарный формат (по умолчанию)

### Планируемые:
- `sqlite`: SQLite база с индексами
- `hdf5`: HDF5 научный формат
- `json`: JSON для отладки

## Матрица доступности тел

| Тело              | NAIF ID     | JPL DE | EPM2021 | Swiss Eph | Нативный интервал |
|-------------------|-------------|--------|---------|-----------|-------------------|
| **Основные планеты** |          |        |         |           |                   |
| Mercury           | 1           | ✅     | ✅      | ✅        | 8 дней            |
| Venus             | 2           | ✅     | ✅      | ✅        | 16 дней           |
| EMB               | 3           | ✅     | ✅      | ❌        | 32 дня            |
| Mars              | 4           | ✅     | ✅      | ✅        | 32 дня            |
| Jupiter           | 5           | ✅     | ✅      | ✅        | 32 дня            |
| Saturn            | 6           | ✅     | ✅      | ✅        | 32 дня            |
| Uranus            | 7           | ✅     | ✅      | ✅        | 64 дня            |
| Neptune           | 8           | ✅     | ✅      | ✅        | 64 дня            |
| Pluto             | 9           | ✅     | ✅      | ✅        | 64 дня            |
| Sun               | 10          | ✅     | ✅      | ✅        | 32 дня            |
| Moon              | 301         | ✅     | ✅      | ✅        | 8 дней            |
| Earth             | 399         | ✅     | ✅      | ✅        | 32 дня            |
| **Барицентры**    |             |        |         |           |                   |
| Mercury Bary      | 199         | ❌     | ✅      | ❌        | 8 дней            |
| Venus Bary        | 299         | ❌     | ✅      | ❌        | 16 дней           |
| Pluto-Charon      | 1000000001  | ❌     | ✅      | ❌        | 64 дня            |
| **Астероиды**     |             |        |         |           |                   |
| Ceres             | 2000001     | ❌     | ✅      | ✅        | 32 дня            |
| Pallas            | 2000002     | ❌     | ✅      | ✅        | 32 дня            |
| Vesta             | 2000004     | ❌     | ✅      | ✅        | 32 дня            |
| Iris              | 2000007     | ❌     | ✅      | ❌        | 32 дня            |
| Bamberga          | 2000324     | ❌     | ✅      | ❌        | 32 дня            |
| **TNO / Карликовые планеты** |  |        |         |           |                   |
| Sedna             | 2090377     | ❌     | ✅      | ❌        | 128 дней          |
| Haumea            | 2136108     | ❌     | ✅      | ❌        | 64 дня            |
| Eris              | 2136199     | ❌     | ✅      | ❌        | 128 дней          |
| Makemake          | 2136472     | ❌     | ✅      | ❌        | 64 дня            |
| **Специальные** (только Swiss) | |      |         |           |                   |
| Chiron            | 15          | ❌     | ❌      | ✅        | Переменный        |
| Pholus            | 16          | ❌     | ❌      | ✅        | Переменный        |
| Mean Lunar Node   | 10          | ❌     | ❌      | ✅        | Предвычислено     |
| True Lunar Node   | 11          | ❌     | ❌      | ✅        | Предвычислено     |
| Lilith (Mean Apo) | 12          | ❌     | ❌      | ✅        | Предвычислено     |

**Итого:**
- **JPL DE**: 12-14 тел (научная точность)
- **EPM2021**: 22 тела (расширенный набор, уникальные TNO)
- **Swiss Eph**: Основные + Chiron, Pholus, Nodes, Lilith (астрология)

## Рекомендации по выбору

### Для научных расчётов:
✅ **JPL DE440** (`--source de440 --profile standard`)
- Максимальная точность
- Современные константы

### Для исследований TNO и астероидов:
✅ **EPM2021** (`--source epm2021 --profile full_epm`)
- Уникальные тела: Sedna, Haumea, Eris, Makemake
- 5 астероидов главного пояса
- Хорошая точность

### Для астрологии:
✅ **Swiss Ephemeris** (напрямую через FFI, не через конвертер)
- Chiron, Pholus
- Лунные узлы
- Lilith (Black Moon)

### Для исторических расчётов:
✅ **JPL DE431** или **DE441** (`--source de431_part1 --profile standard`)
- Покрытие 30,000+ лет
- Стабильная долгосрочная динамика

## Производительность

| Операция              | DE440 (12 тел) | EPM2021 (21 тело) | DE431 Part1 |
|-----------------------|----------------|-------------------|-------------|
| Конвертация           | ~2 мин         | ~5 мин            | ~30 мин     |
| Размер .eph           | ~20 MB         | ~45 MB            | ~300 MB     |
| PHP fseek доступ      | <1 мс          | <1 мс             | <1 мс       |
| Python compute        | ~5 мкс         | ~5 мкс            | ~5 мкс      |

## SPICE Toolkit

Установлен для точного извлечения интервалов (vendor/spice/cspice):
- **BRIEF**: Анализ SPK файлов
- **SPACIT**: Конвертация форматов
- **COMMNT**: Метаданные

**Использование:**
```bash
vendor\spice\cspice\exe\brief.exe -t -c data/ephemerides/epm/2021/spice/epm2021.bsp
```

## TODO / Будущие улучшения

- [ ] Реализовать индивидуальные интервалы в spice2eph.py (сейчас используется средний)
- [ ] Добавить merge для DE431 Part 1 + Part 2
- [ ] Поддержка SQLite и HDF5 форматов
- [ ] Автоматическое извлечение интервалов через SPICE C API
- [ ] Swiss Ephemeris интеграция в конвертер
- [ ] Валидация данных после конвертации
- [ ] Benchmark производительности разных интервалов

## Заключение

Универсальный конвертер обеспечивает:
- ✅ Гибкость выбора тел и интервалов
- ✅ Оптимизацию размера файлов (70-80% сжатие)
- ✅ Доступ к уникальным телам (TNO в EPM2021)
- ✅ Простую конфигурацию через JSON
- ✅ Готовые профили для типовых задач

**Используйте профиль `full_epm` для получения максимального набора тел, включая уникальные TNO!**
